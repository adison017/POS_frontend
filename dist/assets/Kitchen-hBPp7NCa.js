import{r as n,y as h,j as e}from"./index-C7VodmU4.js";import{getOrdersPage as S,getOrderItems as G,getMenuItems as J,getKitchenTickets as X}from"./dataService-DioIbMCu.js";import{s as Z}from"./socket-BBuNZ37k.js";import"./apiClient-CgrKIHeM.js";const ne=()=>{const[m,v]=n.useState([]),[j,H]=n.useState({}),[N,I]=n.useState([]),[x,B]=n.useState("all"),[u,A]=n.useState(""),[g,T]=n.useState(""),[ee,p]=n.useState([]),[P,M]=n.useState([]),[D,z]=n.useState({}),[_,R]=n.useState(0),[L,E]=n.useState(!0),[f,C]=n.useState(!1);n.useEffect(()=>{(async()=>{try{const r=await J(),s=Array.isArray(r)?r.filter(Boolean):[];M(s)}catch(r){console.error("Error loading menu items:",r),h.error("ไม่สามารถโหลดข้อมูลเมนูได้"),M([])}})()},[]);const b=n.useCallback(async(t=0)=>{if(!f){C(!0);try{const s=t*20,o=await S({limit:20,offset:s}),c=Array.isArray(o)?o.filter(Boolean):[];if(v(t===0?c:l=>[...l,...c]),E(c.length===20),R(t),c.length>0){const l=await Promise.all(c.map(a=>G(a.id))),i={...j};c.forEach((a,y)=>{const d=l[y]||[];i[a.id]=Array.isArray(d)?d.filter(Boolean):[]}),H(i)}}catch(r){console.error("Error loading orders:",r),h.error("ไม่สามารถโหลดข้อมูลคำสั่งซื้อได้"),E(!1)}finally{C(!1)}}},[f,j]);n.useEffect(()=>{let t=!0;return(async()=>{try{t&&await b(0)}catch(s){console.error("Error loading initial orders:",s),t&&h.error("ไม่สามารถโหลดข้อมูลคำสั่งซื้อได้")}})(),()=>{t=!1}},[b]);const w=n.useCallback(()=>{if(!L||f)return;const t=document.documentElement.scrollTop,r=document.documentElement.scrollHeight,s=document.documentElement.clientHeight;t+s>=r-100&&b(_+1)},[L,f,_,b]);n.useEffect(()=>(window.addEventListener("scroll",w),()=>window.removeEventListener("scroll",w)),[w]),n.useEffect(()=>{(async()=>{try{const s=await X(),o=Array.isArray(s)?s.filter(Boolean):[];p(o)}catch(s){console.error("Error loading kitchen tickets:",s),h.error("ไม่สามารถโหลดข้อมูลตั๋วครัวได้"),p([])}})();const r=Z.connectSocket();return r.on("kitchen-ticket:created",s=>{p(o=>[s,...o])}),r.on("kitchen-ticket:updated",s=>{p(o=>o.map(c=>c.id===s.id?s:c))}),r.on("order:created",async()=>{try{const s=await S({limit:20,offset:0}),o=Array.isArray(s)?s.filter(Boolean):[];v(o)}catch(s){console.error("Error reloading orders:",s)}}),()=>{r.off("kitchen-ticket:created"),r.off("kitchen-ticket:updated"),r.off("order:created")}},[]),n.useEffect(()=>{(()=>{const r=new Date;let s=[...m];switch(x){case"today":const o=new Date(r.getFullYear(),r.getMonth(),r.getDate());s=m.filter(i=>new Date(i.created_at)>=o);break;case"week":const c=new Date(r);c.setDate(r.getDate()-7),s=m.filter(i=>new Date(i.created_at)>=c);break;case"month":const l=new Date(r);l.setMonth(r.getMonth()-1),s=m.filter(i=>new Date(i.created_at)>=l);break;case"custom":if(u&&g){const i=new Date(u),a=new Date(g);a.setHours(23,59,59,999),s=m.filter(y=>{const d=new Date(y.created_at);return d>=i&&d<=a})}break}I(s)})()},[m,x,u,g]);const V=t=>({pending:"รอดำเนินการ",paid:"ชำระเงินแล้ว",cancelled:"ยกเลิก"})[t]??t??"-",W=t=>({pending:"bg-amber-100 text-amber-800 border-amber-200",paid:"bg-emerald-100 text-emerald-800 border-emerald-200",cancelled:"bg-rose-100 text-rose-800 border-rose-200"})[t]||"bg-gray-100 text-gray-800 border-gray-200",U=t=>({pm_cash:"เงินสด",pm_credit:"บัตรเครดิต",pm_debit:"บัตรเดบิต",pm_qr:"QR Payment",cash:"เงินสด",transfer:"โอนเงิน",promptpay:"พร้อมเพย์"})[t]||t||"ไม่ระบุ",F=t=>({pm_cash:"bg-emerald-100 text-emerald-800 border-emerald-200",pm_credit:"bg-blue-100 text-blue-800 border-blue-200",pm_debit:"bg-blue-100 text-blue-800 border-blue-200",pm_qr:"bg-violet-100 text-violet-800 border-violet-200",cash:"bg-emerald-100 text-emerald-800 border-emerald-200",transfer:"bg-blue-100 text-blue-800 border-blue-200",promptpay:"bg-violet-100 text-violet-800 border-violet-200"})[t]||"bg-gray-100 text-gray-800 border-gray-200",$=t=>{switch(t){case"pm_cash":case"cash":return e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"})});case"pm_credit":case"pm_debit":case"transfer":return e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"})});case"pm_qr":case"promptpay":return e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"})});default:return e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}},q=t=>{z(r=>({...r,[t]:!r[t]}))},K=async(t,r)=>{try{const o=await(await fetch(r,{credentials:"omit"})).blob(),c=URL.createObjectURL(o),l=document.createElement("a");l.href=c,l.download=`${t||"receipt"}.png`,document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(c)}catch(s){console.error("Download receipt failed",s),h.error("ไม่สามารถดาวน์โหลดสลิปได้")}},k=t=>`฿${t?.toFixed(2)||"0.00"}`,Q=t=>t?new Date(t).toLocaleDateString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-",Y=t=>P.find(r=>r.id===t);return e.jsx("div",{id:"purchaseHistorySection",className:"p-4 md:p-6",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-md p-4 md:p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"ประวัติการซื้อ"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"กรองตามวันที่:"}),e.jsxs("select",{value:x,onChange:t=>B(t.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"all",children:"ทั้งหมด"}),e.jsx("option",{value:"today",children:"วันนี้"}),e.jsx("option",{value:"week",children:"7 วันที่แล้ว"}),e.jsx("option",{value:"month",children:"30 วันที่แล้ว"}),e.jsx("option",{value:"custom",children:"กำหนดเอง"})]}),x==="custom"&&e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"date",value:u,onChange:t=>A(t.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm"}),e.jsx("span",{className:"text-gray-500",children:"ถึง"}),e.jsx("input",{type:"date",value:g,onChange:t=>T(t.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm"})]})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:N.length===0?e.jsxs("div",{className:"col-span-full text-center py-16",children:[e.jsx("div",{className:"text-gray-400 mb-4",children:e.jsx("svg",{className:"w-20 h-20 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"1.5",d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-600 mb-2",children:"ไม่มีประวัติการซื้อ"}),e.jsx("p",{className:"text-gray-500",children:"ไม่พบคำสั่งซื้อที่ตรงกับเงื่อนไขการกรอง"})]}):N.map(t=>{const r=t?.id,s=(j?.[r]??[]).filter(Boolean),o=t?.order_no??r??"-",c=t?.status??"pending",l=Q(t?.created_at),i=t?.grand_total??0;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-5 shadow-sm transition-all duration-200 hover:shadow-md",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-lg text-gray-800",children:["ออเดอร์ #",o]}),e.jsx("p",{className:"text-sm text-gray-500",children:l})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-bold border ${W(c)}`,children:V(c)}),e.jsx("span",{className:"font-bold text-lg text-gray-800",children:k(i)}),t?.receipt_url&&e.jsx("button",{onClick:()=>q(r),className:"px-3 py-1.5 text-sm bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg border border-indigo-200",children:D[r]?"ซ่อนสลิป":"ดูสลิป"})]})]}),t?.payment_method&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"text-xs text-gray-500 mr-2",children:"วิธีการชำระเงิน:"}),e.jsxs("div",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${F(t.payment_method)}`,children:[e.jsx("span",{className:"mr-1",children:$(t.payment_method)}),U(t.payment_method)]})]})}),e.jsx("div",{className:"space-y-3 mb-4",children:s.length>0?s.map(a=>{const d=Y(a?.item_id)?.image_url;return e.jsxs("div",{className:"flex items-center py-2 border-b border-gray-100 last:border-0",children:[d?e.jsx("img",{src:d,alt:a.name,className:"w-12 h-12 object-cover rounded-lg mr-3",onError:O=>{O.target.onerror=null,O.target.parentElement.innerHTML=`
                                    <div class="w-12 h-12 bg-gray-100 rounded-lg mr-3 flex items-center justify-center">
                                      <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                      </svg>
                                    </div>
                                  `}}):e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-lg mr-3 flex items-center justify-center",children:e.jsx("svg",{className:"w-6 h-6 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-700 truncate",children:a?.name||"ไม่พบชื่อเมนู"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-gray-600 text-sm",children:["x",a?.qty??0]}),e.jsx("span",{className:"font-bold text-gray-800",children:k(a?.total_price)})]})]})]},a?.id??Math.random())}):e.jsx("p",{className:"text-gray-500 text-center py-2",children:"ไม่มีรายการอาหาร"})}),e.jsxs("div",{className:"flex justify-between items-center pt-3 border-t border-gray-100",children:[e.jsxs("div",{className:"text-sm text-gray-500",children:["จำนวน ",s.length," รายการ"]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"รวมทั้งหมด"}),e.jsx("div",{className:"font-bold text-lg text-gray-800",children:k(i)})]})]}),t?.receipt_url&&D[r]&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"สลิปการชำระเงิน"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>K(o,t.receipt_url),className:"px-3 py-1.5 text-sm bg-white hover:bg-gray-50 text-gray-700 rounded-lg border border-gray-200",children:"ดาวน์โหลด"})})]}),e.jsx("div",{className:"border border-gray-200 rounded-xl overflow-hidden bg-white",children:e.jsx("img",{src:t.receipt_url,alt:`receipt-${o}`,className:"w-full h-auto max-h-[70vh] object-contain",onError:a=>{a.target.onerror=null,a.target.parentElement.innerHTML='<div class="p-6 text-center text-gray-400">ไม่สามารถแสดงสลิปได้</div>'}})})]})]},r??Math.random())})})]})})};export{ne as default};
